<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Meta Quest — Throwable Ball (Improved)</title>

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- Physics System -->
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <!-- Super Hands for grabbing -->
    <script src="https://cdn.jsdelivr.net/gh/wmurphyrd/aframe-super-hands-component@5.0.3/dist/aframe-super-hands-component.min.js"></script>
    <!-- Extras for locomotion -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
  </head>

  <body>
    <a-scene background="color: #88c"
             renderer="colorManagement: true"
             physics="debug: false; gravity: 0 -9.8 0">

      <!-- 카메라 리그: 이동 및 컨트롤러 포함 -->
      <a-entity id="cameraRig" movement-controls position="0 1.4 0">
        <!-- 시야 카메라 -->
        <a-entity id="camera" camera look-controls></a-entity>

        <!-- 왼손: 이동용 -->
        <a-entity id="leftHand"
                  hand-controls="hand: left; handModelStyle: lowPoly; color: #66ccff"
                  teleport-controls="cameraRig: #cameraRig"
                  super-hands></a-entity>

        <!-- 오른손: 공 잡기/던지기 -->
        <a-entity id="rightHand"
                  hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcc00"
                  super-hands></a-entity>
      </a-entity>

      <!-- 바닥 -->
      <a-plane rotation="-90 0 0"
               width="40" height="40"
               color="#3a6"
               static-body></a-plane>

      <!-- 장애물 / 타겟 -->
      <a-box position="0 1 -10"
             width="20" height="4" depth="1"
             color="#6a6" static-body></a-box>

      <!-- 공 스포너 -->
      <script>
        AFRAME.registerComponent('ball-spawner', {
          init: function () {
            const scene = this.el.sceneEl;
            const camera = scene.querySelector('#camera');

            function spawnBall() {
              const camWorld = new THREE.Vector3();
              camera.object3D.getWorldPosition(camWorld);

              const forward = new THREE.Vector3(0, 0, -1);
              forward.applyQuaternion(camera.object3D.getWorldQuaternion(new THREE.Quaternion()));

              // 👇 공 위치를 시야 중심 높이에 맞게 약간 위로 조정
              const spawnPos = camWorld.clone().add(forward.multiplyScalar(0.8)).add(new THREE.Vector3(0, -0.05, 0));

              const ball = document.createElement('a-sphere');
              ball.setAttribute('radius', 0.12);
              ball.setAttribute('position', `${spawnPos.x} ${spawnPos.y} ${spawnPos.z}`);
              ball.setAttribute('color', '#ffffff');
              ball.setAttribute('class', 'interactable grabbable throwable');
              ball.setAttribute('dynamic-body', 'shape: sphere; mass: 0.43; linearDamping: 0.01; angularDamping: 0.01');

              // 일정 시간 후 자동 제거 (너무 많이 쌓이지 않게)
              setTimeout(() => {
                if (ball.parentNode) ball.parentNode.removeChild(ball);
              }, 20000);

              scene.appendChild(ball);
            }

            // 시작 시 공 1개 생성
            spawnBall();

            // 'A' 키 누르면 새 공 생성
            window.addEventListener('keydown', (e) => {
              if (e.key === 'a' || e.key === 'A') spawnBall();
            });
          }
        });

        document.addEventListener('DOMContentLoaded', () => {
          const scene = document.querySelector('a-scene');
          scene.setAttribute('ball-spawner', '');
        });
      </script>
    </a-scene>
  </body>
</html>
